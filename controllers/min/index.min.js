var Request=require("../models/request.js"),Contribution=require("../models/contribute.js"),accountSid="ACa95b3f3758879b557dd75a2f33680c7d",authToken="10034e5971d871bf22b35c3f784430fa",client=require("twilio")(accountSid,authToken),sendMessage=function(e,t){var n="Message from Nightingale Relief Assistance Team, - "+e.fName+", good news!  "+t.contributorFName+" "+t.contributorLName+" has contributed "+t.quantityContributed+" "+e.requestType+" towards your "+e.requestType+" request.  "+t.contributorFName+"'s  phone# is "+t.contributorPhone+".  Regards,  The Nightingale Relief Assistance Team",s="Message from Nightingale Relief Assistance Team, - "+t.contributorFName+", Thank you for your "+t.quantityContributed+" "+e.requestType+" contribution to "+e.fName+" "+e.lName+"'s "+e.requestType+" request.  "+e.fName+"'s phone# is "+e.phone+".  Regards,  The Nightingale Relief Assistance Team";client.messages.create({body:n,to:e.phone,from:"7033489714"},function(e,t){console.log("err:",e),console.log("message:",t),process.stdout.write(t.sid)}),client.messages.create({body:s,to:t.contributorPhone,from:"7033489714"},function(e,t){process.stdout.write(t.sid)})},indexController={index:function(e,t){Request.find({},function(e,n){for(var s=[],i=[],o=[],u=[],r=[],a=[],q=0;q<n.length;q++)"water"===n[q].requestType&&s.push(n[q]);for(var q=0;q<n.length;q++)"clothing"===n[q].requestType&&i.push(n[q]);for(var q=0;q<n.length;q++)"pets"===n[q].requestType&&o.push(n[q]);for(var q=0;q<n.length;q++)"meals"===n[q].requestType&&u.push(n[q]);for(var q=0;q<n.length;q++)"lodging"===n[q].requestType&&r.push(n[q]);for(var q=0;q<n.length;q++)"transportation"===n[q].requestType&&a.push(n[q]);console.log(u),t.render("index",{transportRequests:a,lodgeRequests:r,mealsRequests:u,petsRequests:o,clothingRequests:i,waterRequests:s,requests:n})})},requestMarkers:function(e,t){Request.find({requestFullfilled:!1},function(e,n){t.send(n)})},reliefStatus:function(e,t){var n={clothes:{displayName:"Clothing",id:"clothing",icon:" fa fa-group fa-icon",requests:0,quantity:0},lodge:{displayName:"Lodging",id:"lodging",icon:" fa fa-home fa-icon",requests:0,quantity:0},meals:{displayName:"Meals",id:"meals",icon:" fa fa-cutlery fa-icon",requests:0,quantity:0},pets:{displayName:"Pet Boarding",id:"pet-boarding",icon:" fa fa-paw fa-icon",requests:0,quantity:0},transport:{displayName:"Transportation",id:"transportation",icon:" fa fa-car fa-icon",requests:0,quantity:0},water:{displayName:"Bottles of Water",id:"water",icon:" fa fa-tint fa-icon",requests:0,quantity:0}};Request.find({requestFullfilled:!1},function(e,s){for(var i=0;i<s.length;i++){if("water"===s[i].requestType&&s[i].quantityRequested>0){n.water.requests+=1,n.water.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.water.quantity-=s[i].contributions[o].quantityContributed}if("clothing"===s[i].requestType&&s[i].quantityRequested>0){n.clothes.requests+=1,n.clothes.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.clothes.quantity-=s[i].contributions[o].quantityContributed}if("pets"===s[i].requestType&&s[i].quantityRequested>0){n.pets.requests+=1,n.pets.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.pets.quantity-=s[i].contributions[o].quantityContributed}if("lodging"===s[i].requestType&&s[i].quantityRequested>0){n.lodge.requests+=1,n.lodge.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.lodge.quantity-=s[i].contributions[o].quantityContributed}if("meals"===s[i].requestType&&s[i].quantityRequested>0){n.meals.requests+=1,n.meals.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.meals.quantity-=s[i].contributions[o].quantityContributed}if("transportation"===s[i].requestType&&s[i].quantityRequested>0){n.transport.requests+=1,n.transport.quantity+=s[i].quantityRequested;for(var o=0;o<s[i].contributions.length;o++)n.transport.quantity-=s[i].contributions[o].quantityContributed}}t.send(n)})},reliefRequests:function(e,t){Request.find({requestFullfilled:!1},function(e,n){t.send(n)})},aidSubmit:function(e,t){var n=new Request(e.body);n.save(function(e,n){e?t.send(500,"ERROR"):t.send(n)})},contSubmit:function(e,t){var n=JSON.parse(e.body.contributions);n.map(function(e){Request.findOne({_id:e._id},function(t,n){n.contributions.push(e);for(var s=0,i=0;i<n.contributions.length;i++)s+=n.contributions[i].quantityContributed||0;n.totalContributed=s,s>=n.quantityRequested&&(n.requestFullfilled=!0),n.save(function(){sendMessage(n,e)})})}),t.send("ok")}};module.exports=indexController;